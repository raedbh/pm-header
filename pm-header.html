<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/social-icons.html">

<dom-module id="pm-header">
  <template>
    <style>
      :host {
        display: inline-block;
        --main-bg-color: #7e7e7e;
        width: 100%;
      }

      iron-icon {
        fill: currentcolor;
      }

      nav {
        background-color: #fff;
        border: 1px solid #dedede;
        border-radius: 0px;
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.055);
        color: #888;
        display: block;
        margin: 8px 22px 8px 22px;
        overflow: hidden;
        margin: auto;
      }

      nav ul {
        margin: 0;
        padding: 0;
      }

      nav ul li {
        display: inline-block;
        list-style-type: none;

        -webkit-transition: all 0.2s;
        -moz-transition: all 0.2s;
        -ms-transition: all 0.2s;
        -o-transition: all 0.2s;
        transition: all 0.2s;
      }

      nav>ul>li>a {
        color: #aaa;
        display: block;
        line-height: 48px;
        padding: 0 18px;
        text-decoration: none;
      }

      nav>ul>li:hover {
        background-color: var(--main-bg-color);
      }

      nav>ul>li:hover>a {
        color: rgb( 255, 255, 255);
      }

      nav>ul>li>div {
        background-color: var(--main-bg-color);
        border-top: 0;
        border-radius: 0 0 4px 4px;
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.055);
        display: none;
        margin: 0;
        opacity: 0;
        position: absolute;
        min-width: 165px;
        visibility: hidden;

        -webkit-transiton: opacity 0.2s;
        -moz-transition: opacity 0.2s;
        -ms-transition: opacity 0.2s;
        -o-transition: opacity 0.2s;
        -transition: opacity 0.2s;
      }

      nav>ul>li:hover>div {
        display: block;
        opacity: 1;
        visibility: visible;
        z-index: 1000;
      }

      nav>ul>li>div ul>li {
        display: block;
        position: relative;
      }

      nav>ul>li>div ul>li>a {
        color: #fff;
        display: block;
        padding: 12px 24px;
        text-decoration: none;
      }

      nav>ul>li>div ul>li:hover>a {
        background-color: rgba( 255, 255, 255, 0.1);
      }
      .logo>img {
        vertical-align: middle
      }
      .logo:hover {
        background-color: transparent;
      }
      .right {
        float: right;
      }
    </style>

    <nav>
      <ul>
        <li class="logo">
            <img src="[[logo]]">
        </li>
        <li>
          <a href="/">
            <iron-icon icon="icons:home"></iron-icon>
          </a>
        </li>
        <li>
          <a href="#">
            <iron-icon icon="icons:apps"></iron-icon>
          </a>
          <div>
            <ul>
              <template is="dom-repeat" items="{{addons}}">
                <li>
                  <a href="[[item.menu_item.link]]">[[item.menu_item.label]]</a>
                </li>
              </template>
            </ul>
          </div>
        </li>

        <li class="right">
          <a href="#">
            <iron-icon icon="icons:account-circle"></iron-icon>
          </a>
        </li>

        <li class="right">
          <a href="#">
            <iron-icon icon="social:notifications-none"></iron-icon>
            [[count]]
          </a>
        </li>

      </ul>
    </nav>

  </template>

  <script>
    /**
     * `pm-header`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class PmHeader extends Polymer.Element {

      constructor() {
        super();
        this._boundListener = this.alertHandler.bind(this);
      }

      static get is() { return 'pm-header'; }

      static get properties() {
        return {
          theme: {
            type: String
          },
          logo: {
            type: String
          },
          count: {
            type: Number,
            value: 0
          }
        };
      }

      ready() {
        super.ready();

        let color = '#7e7e7e';
        switch (this.theme) {
          case 'gray':
            color = '#7e7e7e';
            break;
          case 'entervo':
            color = '#424242';
            this.logo = "../images/entervo.png";
            break;
          case 'indigo':
            color = '#7986CB';
            break;
          default:
            break;
        }
        this.updateStyles({ '--main-bg-color': color });
        // todo : externalize param
        this.addons = this.getAddons("/pm/api/modules");

      }

      getAddons(Url) {
        var request = new XMLHttpRequest();
        request.open('GET', Url, false);  // `false` makes the request synchronous
        request.send(null);

        if (request.status === 200) {
          try {
            return JSON.parse(request.responseText);
          } catch (error) {
            console.warn("Not a Json");
            return null;
          }
        } else {
          return null;
        }
      }

      connectedCallback() {
        super.connectedCallback();
        window.addEventListener('alert', this._boundListener);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        // We must remove listeners to prevent memory leaks.
        window.removeEventListener('alert', this._boundListener);
      }

      alertHandler(alerts) {
        ++this.count;
      }

      static displayAlerts(alerts) {
        var event = new CustomEvent('alert', alerts);
        window.dispatchEvent(event);
      }

    }

    window.customElements.define(PmHeader.is, PmHeader);
  </script>
</dom-module>